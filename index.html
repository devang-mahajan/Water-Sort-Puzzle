<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Sort Puzzle</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --bottle-width: 70px;
            --bottle-height: 180px;
            --segment-height: 40px;
        }

        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #fff;
        }

        .game-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .game-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .game-title {
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .level-display {
            font-size: 1.3rem;
            background: rgba(255,255,255,0.1);
            padding: 8px 20px;
            border-radius: 20px;
            display: inline-block;
        }

        .bottles-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            min-height: 250px;
        }

        .bottle {
            width: var(--bottle-width);
            height: var(--bottle-height);
            background: rgba(255,255,255,0.1);
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 10px 10px 35px 35px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column-reverse;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .bottle:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .bottle.selected {
            transform: translateY(-15px) scale(1.05);
            border-color: #ffd700;
            box-shadow: 0 8px 25px rgba(255,215,0,0.5);
        }

        .bottle.shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .liquid-segment {
            width: 100%;
            height: var(--segment-height);
            transition: all 0.4s ease;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .btn-game {
            padding: 12px 30px;
            font-size: 1.1rem;
            border-radius: 25px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-game:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn-reset {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-undo {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-next {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
        }

        .modal-header {
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .modal-footer {
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        /* Color Palette */
        .color-red { background-color: #ef4444; }
        .color-blue { background-color: #3b82f6; }
        .color-green { background-color: #10b981; }
        .color-yellow { background-color: #f59e0b; }
        .color-purple { background-color: #a855f7; }
        .color-pink { background-color: #ec4899; }
        .color-cyan { background-color: #06b6d4; }
        .color-orange { background-color: #f97316; }
        .color-lime { background-color: #84cc16; }
        .color-indigo { background-color: #6366f1; }
        .color-teal { background-color: #14b8a6; }
        .color-rose { background-color: #f43f5e; }

        @media (max-width: 576px) {
            :root {
                --bottle-width: 60px;
                --bottle-height: 160px;
                --segment-height: 35px;
            }
            .game-title { font-size: 2rem; }
            .bottles-container { gap: 15px; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1 class="game-title">üíß Water Sort Puzzle</h1>
            <div class="level-display" id="levelDisplay">Level 1</div>
        </div>

        <div class="bottles-container" id="bottlesContainer"></div>

        <div class="controls">
            <button class="btn btn-game btn-reset" id="resetBtn">üîÑ Reset</button>
            <button class="btn btn-game btn-undo" id="undoBtn">‚Ü©Ô∏è Undo</button>
        </div>
    </div>

    <!-- Victory Modal -->
    <div class="modal fade" id="victoryModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üéâ Level Complete!</h5>
                </div>
                <div class="modal-body text-center">
                    <p class="fs-4">Congratulations! You've solved the puzzle!</p>
                    <p id="victoryMessage"></p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-game btn-next" id="nextLevelBtn">Next Level ‚û°Ô∏è</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        // Level configurations: Each array represents a bottle, each element is a color segment
        const LEVELS = [
            // Level 1-3: Easy (3-4 bottles, 2-3 colors)
            [
                ['red', 'blue', 'red', 'blue'],
                ['red', 'blue', 'red', 'blue'],
                []
            ],
            [
                ['red', 'green', 'blue', 'red'],
                ['blue', 'green', 'red', 'green'],
                ['blue', 'green', 'red', 'blue'],
                [], []
            ],
            [
                ['yellow', 'red', 'blue', 'yellow'],
                ['red', 'blue', 'yellow', 'red'],
                ['blue', 'yellow', 'red', 'blue'],
                [], []
            ],
            // Level 4-7: Medium (5-7 bottles, 4-5 colors)
            [
                ['purple', 'green', 'red', 'yellow'],
                ['red', 'purple', 'yellow', 'green'],
                ['yellow', 'red', 'green', 'purple'],
                ['green', 'yellow', 'purple', 'red'],
                [], []
            ],
            [
                ['blue', 'pink', 'green', 'yellow'],
                ['green', 'blue', 'pink', 'yellow'],
                ['pink', 'yellow', 'green', 'blue'],
                ['yellow', 'pink', 'blue', 'green'],
                ['blue', 'green', 'pink', 'yellow'],
                [], []
            ],
            [
                ['cyan', 'orange', 'purple', 'red'],
                ['purple', 'red', 'cyan', 'orange'],
                ['orange', 'purple', 'red', 'cyan'],
                ['red', 'cyan', 'orange', 'purple'],
                ['cyan', 'purple', 'orange', 'red'],
                [], []
            ],
            [
                ['lime', 'indigo', 'pink', 'orange', 'cyan'],
                ['orange', 'lime', 'cyan', 'pink', 'indigo'],
                ['pink', 'cyan', 'lime', 'indigo', 'orange'],
                ['indigo', 'orange', 'pink', 'lime', 'cyan'],
                ['cyan', 'pink', 'indigo', 'orange', 'lime'],
                [], []
            ],
            // Level 8-10: Hard (9-12 bottles, 6-8 colors)
            [
                ['teal', 'rose', 'yellow', 'blue'],
                ['blue', 'teal', 'rose', 'yellow'],
                ['rose', 'yellow', 'blue', 'teal'],
                ['yellow', 'blue', 'teal', 'rose'],
                ['green', 'purple', 'orange', 'red'],
                ['red', 'green', 'purple', 'orange'],
                ['purple', 'orange', 'red', 'green'],
                ['orange', 'red', 'green', 'purple'],
                [], []
            ],
            [
                ['cyan', 'pink', 'lime', 'indigo'],
                ['indigo', 'cyan', 'pink', 'lime'],
                ['pink', 'lime', 'indigo', 'cyan'],
                ['lime', 'indigo', 'cyan', 'pink'],
                ['teal', 'rose', 'orange', 'yellow'],
                ['yellow', 'teal', 'rose', 'orange'],
                ['rose', 'orange', 'yellow', 'teal'],
                ['orange', 'yellow', 'teal', 'rose'],
                ['red', 'blue', 'green', 'purple'],
                ['purple', 'red', 'blue', 'green'],
                [], []
            ],
            [
                ['red', 'blue', 'green', 'yellow'],
                ['yellow', 'red', 'blue', 'green'],
                ['green', 'yellow', 'red', 'blue'],
                ['blue', 'green', 'yellow', 'red'],
                ['purple', 'pink', 'cyan', 'orange'],
                ['orange', 'purple', 'pink', 'cyan'],
                ['pink', 'cyan', 'orange', 'purple'],
                ['cyan', 'orange', 'purple', 'pink'],
                ['lime', 'indigo', 'teal', 'rose'],
                ['rose', 'lime', 'indigo', 'teal'],
                ['indigo', 'teal', 'rose', 'lime'],
                ['teal', 'rose', 'lime', 'indigo'],
                [], []
            ]
        ];

        class Game {
            constructor() {
                this.currentLevel = 0;
                this.bottles = [];
                this.selectedBottleIndex = null;
                this.moveHistory = [];
                this.maxCapacity = 4;
                
                this.initializeElements();
                this.loadLevel(this.currentLevel);
                this.attachEventListeners();
            }

            initializeElements() {
                this.bottlesContainer = document.getElementById('bottlesContainer');
                this.levelDisplay = document.getElementById('levelDisplay');
                this.resetBtn = document.getElementById('resetBtn');
                this.undoBtn = document.getElementById('undoBtn');
                this.nextLevelBtn = document.getElementById('nextLevelBtn');
                this.victoryModal = new bootstrap.Modal(document.getElementById('victoryModal'));
            }

            loadLevel(levelIndex) {
                if (levelIndex >= LEVELS.length) {
                    this.showGameComplete();
                    return;
                }

                this.currentLevel = levelIndex;
                this.bottles = LEVELS[levelIndex].map(bottle => [...bottle]);
                this.selectedBottleIndex = null;
                this.moveHistory = [];
                
                this.levelDisplay.textContent = `Level ${levelIndex + 1}`;
                this.render();
            }

            render() {
                this.bottlesContainer.innerHTML = '';
                
                this.bottles.forEach((bottle, index) => {
                    const bottleEl = document.createElement('div');
                    bottleEl.className = 'bottle';
                    bottleEl.dataset.index = index;
                    
                    if (this.selectedBottleIndex === index) {
                        bottleEl.classList.add('selected');
                    }

                    // Render liquid segments from bottom to top
                    bottle.forEach(color => {
                        const segment = document.createElement('div');
                        segment.className = `liquid-segment color-${color}`;
                        bottleEl.appendChild(segment);
                    });

                    this.bottlesContainer.appendChild(bottleEl);
                });
            }

            attachEventListeners() {
                this.bottlesContainer.addEventListener('click', (e) => {
                    const bottleEl = e.target.closest('.bottle');
                    if (bottleEl) {
                        const index = parseInt(bottleEl.dataset.index);
                        this.handleBottleClick(index);
                    }
                });

                this.resetBtn.addEventListener('click', () => this.resetLevel());
                this.undoBtn.addEventListener('click', () => this.undoMove());
                this.nextLevelBtn.addEventListener('click', () => {
                    this.victoryModal.hide();
                    this.loadLevel(this.currentLevel + 1);
                });
            }

            handleBottleClick(index) {
                if (this.selectedBottleIndex === null) {
                    // Select bottle
                    if (this.bottles[index].length > 0) {
                        this.selectedBottleIndex = index;
                        this.render();
                    }
                } else if (this.selectedBottleIndex === index) {
                    // Deselect
                    this.selectedBottleIndex = null;
                    this.render();
                } else {
                    // Attempt pour
                    this.attemptPour(this.selectedBottleIndex, index);
                }
            }

            attemptPour(sourceIndex, targetIndex) {
                const sourceBottle = this.bottles[sourceIndex];
                const targetBottle = this.bottles[targetIndex];

                // Validation: O(1) complexity
                if (!this.isValidMove(sourceBottle, targetBottle)) {
                    this.showInvalidMove(sourceIndex);
                    return;
                }

                // Save state for undo
                this.saveMove(sourceIndex, targetIndex);

                // Pour logic: Move all consecutive top colors
                const topColor = sourceBottle[sourceBottle.length - 1];
                let pourCount = 0;

                // Count consecutive segments of same color from top
                for (let i = sourceBottle.length - 1; i >= 0; i--) {
                    if (sourceBottle[i] === topColor && targetBottle.length + pourCount < this.maxCapacity) {
                        pourCount++;
                    } else {
                        break;
                    }
                }

                // Transfer segments
                for (let i = 0; i < pourCount; i++) {
                    targetBottle.push(sourceBottle.pop());
                }

                this.selectedBottleIndex = null;
                this.render();

                // Check win condition
                setTimeout(() => this.checkWinCondition(), 500);
            }

            isValidMove(sourceBottle, targetBottle) {
                // Rule 1: Source cannot be empty
                if (sourceBottle.length === 0) {
                    console.warn('‚ö†Ô∏è Source bottle is empty');
                    return false;
                }

                // Rule 2: Target cannot be full
                if (targetBottle.length >= this.maxCapacity) {
                    console.warn('‚ö†Ô∏è Target bottle is full');
                    return false;
                }

                // Rule 3: Target must be empty OR top colors must match
                if (targetBottle.length > 0) {
                    const sourceTopColor = sourceBottle[sourceBottle.length - 1];
                    const targetTopColor = targetBottle[targetBottle.length - 1];
                    
                    if (sourceTopColor !== targetTopColor) {
                        console.warn('‚ö†Ô∏è Colors do not match');
                        return false;
                    }
                }

                return true;
            }

            showInvalidMove(bottleIndex) {
                const bottleEl = this.bottlesContainer.children[bottleIndex];
                bottleEl.classList.add('shake');
                setTimeout(() => bottleEl.classList.remove('shake'), 500);
                this.selectedBottleIndex = null;
                this.render();
            }

            saveMove(sourceIndex, targetIndex) {
                // Deep clone current state for undo
                this.moveHistory.push({
                    bottles: this.bottles.map(bottle => [...bottle]),
                    source: sourceIndex,
                    target: targetIndex
                });
            }

            undoMove() {
                if (this.moveHistory.length === 0) return;

                const previousState = this.moveHistory.pop();
                this.bottles = previousState.bottles;
                this.selectedBottleIndex = null;
                this.render();
            }

            resetLevel() {
                this.loadLevel(this.currentLevel);
            }

            checkWinCondition() {
                // Win condition: All non-empty bottles have 4 segments of same color
                const isWin = this.bottles.every(bottle => {
                    if (bottle.length === 0) return true;
                    if (bottle.length !== this.maxCapacity) return false;
                    return bottle.every(color => color === bottle[0]);
                });

                if (isWin) {
                    const victoryMessage = document.getElementById('victoryMessage');
                    if (this.currentLevel === LEVELS.length - 1) {
                        victoryMessage.textContent = 'üèÜ You completed all levels!';
                    } else {
                        victoryMessage.textContent = `Moves: ${this.moveHistory.length}`;
                    }
                    this.victoryModal.show();
                }
            }

            showGameComplete() {
                const victoryMessage = document.getElementById('victoryMessage');
                victoryMessage.textContent = 'üéä Congratulations! You beat the entire game!';
                document.getElementById('nextLevelBtn').style.display = 'none';
                this.victoryModal.show();
            }
        }

        // Initialize game on page load
        document.addEventListener('DOMContentLoaded', () => {
            new Game();
        });
    </script>
</body>
</html>
